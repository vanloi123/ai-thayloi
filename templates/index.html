<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Trợ giảng AI đa môn học</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.css">
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"></script>

  <script>
    window.MathJax = {
      loader: {load: ['[tex]/mhchem']}, // Tải gói Hóa học
      tex: {
        packages: {'[+]': ['mhchem']},   // Kích hoạt gói Hóa học
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    /* Custom Variables & Global Styles */
    :root {
      --primary: #00E6E6; 
      --bg-dark: #090E17; 
      --bg-light: #F8FAFC; 
      --text-dark: #F1F5F9; 
      --text-light: #1E293B; 
      --card-dark: rgba(255, 255, 255, 0.08); 
      --card-light: #FFFFFF;
      --light-hover: #EBF1F7; 
    }

    html, body {
      height: 100%; margin: 0;
      font-family: "Segoe UI", Roboto, system-ui, Arial, sans-serif;
      background: var(--bg-dark); color: var(--text-dark);
      transition: background 0.4s ease, color 0.4s ease;
      overflow-x: hidden; 
    }

    body.light { background: var(--bg-light); color: var(--text-light); }
    body.light .sidebar, body.light .offcanvas {
        background: var(--card-light);
        border: 1px solid #E2E8F0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    /* === FIX LIGHT MODE: GHI ĐÈ MÀU CHỮ TRẮNG CỦA TAILWIND === */
    body.light .text-white { color: #1E293B !important; }
    body.light .text-cyan-300 { color: #0284c7 !important; }
    body.light .text-cyan-400 { color: #0ea5e9 !important; }
    body.light input { color: #1E293B !important; }
    body.light input::placeholder { color: #94a3b8 !important; }
    body.light .floating-input-box { border-color: #cbd5e1 !important; }
    /* ========================================================= */

    .sidebar { box-shadow: 0 0 10px rgba(0, 230, 230, 0.1), inset 0 0 4px rgba(0, 230, 230, 0.05); }

    /* App Layout */
    .app-shell {
      display: grid; grid-template-columns: 1fr;
      min-height: 100vh; box-sizing: border-box; padding-bottom: 90px;
    }

    @media (min-width: 1024px) {
        .app-shell {
            grid-template-columns: 280px 1fr;
            padding: 20px; padding-bottom: 20px; gap: 20px;
        }
        .app-shell.dashboard-open { grid-template-columns: 280px 1fr 350px; }
    }

    /* Dashboard */
    #dashboard-container {
        position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 350px;
        z-index: 60; background: var(--bg-dark);
        border-left: 1px solid rgba(0,255,255,0.1); padding: 18px;
        transform: translateX(100%); transition: transform 0.4s ease-in-out; display: block;
    }

    @media (min-width: 1024px) {
        #dashboard-container {
            position: static; width: auto; max-width: none; transform: none !important;
            height: calc(100vh - 40px);
            box-shadow: 0 0 10px rgba(0, 230, 230, 0.1), inset 0 0 4px rgba(0, 230, 230, 0.05);
            border-radius: 16px; display: flex; flex-direction: column;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .app-shell.dashboard-open #dashboard-container { opacity: 1; }
        .app-shell:not(.dashboard-open) #dashboard-container { display: none !important; }
    }
    
    #dashboard-container.mobile-open { transform: translateX(0); display: block; }
    body.light #dashboard-container {
        background: var(--card-light); border: 1px solid #E2E8F0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    @media (min-width: 1024px) {
        .sidebar { position: sticky; top: 20px; height: calc(100vh - 40px); overflow-y: auto; }
    }

    .main {
        display: flex; flex-direction: column; gap: 12px; padding: 12px;
        padding-bottom: 0; min-height: 100%; box-sizing: border-box;
    }
    @media (min-width: 1024px) { .main { padding: 0; padding-top: 1px; } }
    
    .chat-header {
        position: sticky; top: 0; z-index: 30; padding: 1rem; margin-bottom: 12px;
        background: rgba(9, 14, 23, 0.85); backdrop-filter: blur(8px);
        border-radius: 14px; border: 1px solid rgba(0,255,255,0.1);
        transition: background 0.4s ease;
    }
    body.light .chat-header { background: rgba(248, 250, 252, 0.95); border: 1px solid #E2E8F0; }
    @media (max-width: 1023px) {
        .chat-header { position: static !important; background: transparent !important; border: none !important; padding: 0; margin-bottom: 0; }
    }

    .chat-window {
      background: transparent; border-radius: 14px; padding: 18px 0;
      overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 24px;
      padding-top: 50px; min-height: calc(100vh - 100px);
    }
    @media (min-width: 1024px) {
        .chat-window { padding-top: 0; min-height: auto; height: calc(100vh - 40px - 90px); }
    }
    
    .input-wrapper {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; padding: 12px;
        background: linear-gradient(180deg, transparent, var(--bg-dark) 80%);
        transition: background 0.4s ease; padding-bottom: 20px;
    }
    @media (min-width: 1024px) {
        .input-wrapper {
            position: sticky; bottom: 0; z-index: 30; padding: 0;
            background: linear-gradient(0deg, var(--bg-dark) 70%, transparent);
            padding-top: 15px; padding-bottom: 12px; margin-top: auto;
        }
        body.light .input-wrapper { background: linear-gradient(0deg, var(--bg-light) 70%, transparent); }
    }

    .msg { display: flex; gap: 12px; align-items: flex-start; width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden; }
    .msg.user { justify-content: flex-end; }
    /* === AVATAR STYLE MỚI === */
    .msg .avatar {
        min-width: 40px; 
        min-height: 40px;
        border-radius: 12px; 
        display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, #22d3ee, #0ea5e9);
        color: #fff; 
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4), inset 0 1px 1px rgba(255,255,255,0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        flex-shrink: 0; transition: all 0.3s ease;
    }

    .msg:not(.user) .avatar:hover {
        transform: scale(1.05) rotate(-5deg); 
        box-shadow: 0 6px 16px rgba(14, 165, 233, 0.6);
    }

    .msg.user .avatar {
        background: linear-gradient(135deg, #f1f5f9, #cbd5e1);
        color: #334155; font-weight: bold; font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    body.light .msg.user .avatar {
        background: linear-gradient(135deg, #334155, #1e293b);
        color: #fff;
    }

    .bubble {
      max-width: 85%; padding: 14px 18px; border-radius: 24px; line-height: 1.5;
      word-wrap: break-word; transition: background-color 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 0; white-space: pre-wrap;
    }
    
    .bubble.ai {
        background: var(--card-dark); color: var(--text-dark);
        border-top-left-radius: 8px; overflow-x: visible; border: 1px solid rgba(0,255,255,0.05);
    }
    .bubble.ai .markdown h3 {
        margin-top: 1.5rem; margin-bottom: 0.5rem; padding-bottom: 4px;
        border-bottom: 1px dashed rgba(0,255,255,0.2); color: var(--primary);
        font-size: 1.1rem; font-weight: 700;
    }
    body.light .bubble.ai .markdown h3 { border-bottom: 1px dashed #B0BACC; color: var(--text-light); }
    .bubble.ai .markdown ul, .bubble.ai .markdown ol { margin-top: 0.5rem; padding-left: 20px; }

    .bubble.ai.typing-state { min-height: 36px; display: flex; align-items: center; padding: 10px 18px; }
    .cursor { display: inline-block; margin-left: 2px; width: 1px; background-color: var(--primary); animation: blink 1s step-start infinite; height: 1.2em; vertical-align: middle; }
    @keyframes blink { 50% { visibility: hidden; } }
    body.light .cursor { background-color: var(--text-light); }

    .loading-dots span {
        display: inline-block; width: 8px; height: 8px; margin: 0 1px; border-radius: 50%;
        background-color: var(--primary); animation: loading 1.4s infinite ease-in-out; opacity: 0.6;
    }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }
    @keyframes loading { 0%, 80%, 100% { transform: scale(0.6); } 40% { transform: scale(1); } }

    .bubble.user {
        background: var(--primary); color: #1E293B;
        border-top-right-radius: 8px; box-shadow: 0 2px 8px rgba(0,230,230,0.3);
    }
    body.light .bubble.ai { background: #FFFFFF; color: var(--text-light); border: 1px solid #E2E8F0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    body.light .bubble.user { background: var(--primary); color: #1E293B; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    .bubble.ai pre {
        overflow-x: auto; max-width: 100%; padding: 1rem; border-radius: 10px;
        margin-top: 1rem; position: relative; width: 100%; box-sizing: border-box;
        background: #000; border: none;
    }
    body.light .bubble.ai pre { background: #1e293b; }

    .copy-btn {
        position: absolute; top: 8px; right: 8px; padding: 4px 8px;
        background: rgba(255, 255, 255, 0.2); color: #fff; border: none; border-radius: 4px;
        cursor: pointer; font-size: 12px; font-weight: 600; opacity: 0.8;
        transition: opacity 0.2s, background 0.2s; display: flex; align-items: center; gap: 4px; z-index: 10;
    }
    
    .topic-btn {
      width: 100%; text-align: left; padding: 12px 16px; border-radius: 10px;
      transition: 0.2s; font-weight: 500;
    }
    .topic-btn:hover { background: rgba(0,255,255,0.12); }
    .topic-active {
      background: rgba(0,255,255,0.18); border-left: 4px solid var(--primary);
      font-weight: 600; box-shadow: inset 0 0 6px rgba(0, 230, 230, 0.1);
    }
    body.light .topic-btn:hover { background: var(--light-hover); }
    body.light .topic-active { background: #EAF9F9; border-left-color: var(--primary); }

    .pill {
      background: rgba(0,255,255,0.15); color: var(--primary);
      padding: 6px 14px; border-radius: 999px; font-weight: 600; font-size: 0.85rem;
    }
    body.light .pill { background: #E0F7F7; color: #008888; border: none; }

    .offcanvas {
        position: fixed; top: 0; bottom: 0; left: 0; width: 280px; padding: 18px; z-index: 70;
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
        border-right: 1px solid rgba(0,255,255,0.05); backdrop-filter: blur(8px);
        transform: translateX(-100%); transition: transform 0.4s ease-in-out; overflow-y: auto; 
    }
    .offcanvas.open { transform: translateX(0); }

    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 65;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease;
    }
    .overlay.show { opacity: 1; visibility: visible; }
    
    .floating-input-box {
        background: rgba(14, 25, 41, 0.7); backdrop-filter: blur(12px);
        border-radius: 30px; padding: 6px;
        box-shadow: 0 4px 20px rgba(0, 230, 230, 0.2);
        border: 1px solid rgba(0, 230, 230, 0.2);
    }
    body.light .floating-input-box {
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: 1px solid #E2E8F0;
    }
    @media (min-width: 1024px) { .floating-input-box { border-radius: 16px; padding: 8px; } }
    
    #send-btn {
        min-width: 52px; min-height: 52px; border-radius: 24px;
        box-shadow: 0 2px 8px rgba(0, 230, 230, 0.4);
    }
    .mobile-header { backdrop-filter: blur(8px); background: rgba(9, 14, 23, 0.85); }
    body.light .mobile-header { background: rgba(248, 250, 252, 0.85); }
  </style>
</head>
<body>
  <div id="offcanvas" class="offcanvas transition-transform duration-400 ease-in-out lg:hidden" aria-hidden="true">
    <div class="flex items-center gap-3 mb-6 pb-2 border-b border-gray-700/50">
      <img src="{{ url_for('static', filename='logo.png') }}" class="w-10 h-10 rounded-lg shadow-lg">
      <div>
        <div class="text-xl font-extrabold text-white">Trợ giảng AI Cá nhân hóa</div>
        <div class="text-xs text-cyan-300">Hỗ trợ học tập đa môn cho học sinh THPT</div>
      </div>
    </div>

    <div class="space-y-1">
  <button class="topic-btn flex items-center gap-3 group" data-topic="Tổng quát">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 group-hover:text-white transition-colors">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <span>Tổng quát</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Toán">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 group-hover:text-white transition-colors">
      <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
      <line x1="8" y1="12" x2="16" y2="12"></line>
      <line x1="12" y1="8" x2="12" y2="16"></line>
    </svg>
    <span>Toán Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Lý">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 group-hover:text-white transition-colors">
      <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
      <path d="M8.5 8.5v.01"></path>
      <path d="M16 16v.01"></path>
      <path d="M12 12v.01"></path>
      <path d="M12 22c5.523 0 10-4.477 10-10"></path>
      <path d="M2 12h20"></path>
    </svg>
    <span>Vật Lý</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Hóa">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400 group-hover:text-white transition-colors">
      <path d="M10 2v7.31"></path>
      <path d="M14 2v7.31"></path>
      <path d="M8.5 2h7"></path>
      <path d="M14 9.3a6.5 6.5 0 1 1-4 0"></path>
    </svg>
    <span>Hóa Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Sinh">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-400 group-hover:text-white transition-colors">
      <path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4Z"></path>
    </svg>
    <span>Sinh Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Tin học">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400 group-hover:text-white transition-colors">
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
    <span>Tin Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Văn học">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400 group-hover:text-white transition-colors">
      <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
      <line x1="16" y1="8" x2="2" y2="22"></line>
      <line x1="17.5" y1="15" x2="9" y2="15"></line>
    </svg>
    <span>Ngữ Văn</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Lịch Sử">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500 group-hover:text-white transition-colors">
      <path d="M3 22v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3"></path>
      <path d="M12 17v-7"></path>
      <path d="M4 2v3a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2"></path>
      <path d="M12 7V2"></path>
      <line x1="2" y1="22" x2="22" y2="22"></line>
    </svg>
    <span>Lịch Sử</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Địa Lý">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500 group-hover:text-white transition-colors">
      <circle cx="12" cy="12" r="10"></circle>
      <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
      <path d="M2 12h20"></path>
    </svg>
    <span>Địa Lý</span>
  </button>

</div>
    <div class="absolute bottom-4 left-4 right-4">
        <button id="close-offcanvas" class="w-full mt-4 py-3 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold transition">
            Đóng Menu
        </button>
    </div>
  </div>
  <div id="overlay" class="overlay" aria-hidden="true"></div>

  <div class="app-shell">
    <aside class="sidebar hidden lg:block">
      <div class="flex items-center gap-3 mb-6 pb-4 border-b border-cyan-800/50">
        <img src="{{ url_for('static', filename='logo.png') }}" class="w-10 h-10 rounded-lg shadow-lg">
        <div>
          <div class="text-xl font-extrabold text-white">Trợ giảng AI</div>
          <div class="text-xs text-cyan-300">Hỗ trợ học tập đa môn cho học sinh THPT</div>
        </div>
      </div>
      <div class="text-sm text-cyan-400 font-bold mb-2 uppercase tracking-wider">Chọn Môn Học</div>
      <div class="space-y-1">
  <button class="topic-btn flex items-center gap-3 group" data-topic="Tổng quát">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400 group-hover:text-white transition-colors">
      <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
      <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
    </svg>
    <span>Tổng quát</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Toán">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400 group-hover:text-white transition-colors">
      <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
      <line x1="8" y1="12" x2="16" y2="12"></line>
      <line x1="12" y1="8" x2="12" y2="16"></line>
    </svg>
    <span>Toán Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Lý">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-400 group-hover:text-white transition-colors">
      <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
      <path d="M8.5 8.5v.01"></path>
      <path d="M16 16v.01"></path>
      <path d="M12 12v.01"></path>
      <path d="M12 22c5.523 0 10-4.477 10-10"></path>
      <path d="M2 12h20"></path>
    </svg>
    <span>Vật Lý</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Hóa">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400 group-hover:text-white transition-colors">
      <path d="M10 2v7.31"></path>
      <path d="M14 2v7.31"></path>
      <path d="M8.5 2h7"></path>
      <path d="M14 9.3a6.5 6.5 0 1 1-4 0"></path>
    </svg>
    <span>Hóa Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Sinh">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-pink-400 group-hover:text-white transition-colors">
      <path d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 1 0 0-8c-2 0-4 1.33-6 4Z"></path>
    </svg>
    <span>Sinh Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Tin học">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400 group-hover:text-white transition-colors">
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
    <span>Tin Học</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Văn học">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-400 group-hover:text-white transition-colors">
      <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path>
      <line x1="16" y1="8" x2="2" y2="22"></line>
      <line x1="17.5" y1="15" x2="9" y2="15"></line>
    </svg>
    <span>Ngữ Văn</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Lịch Sử">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500 group-hover:text-white transition-colors">
      <path d="M3 22v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3"></path>
      <path d="M12 17v-7"></path>
      <path d="M4 2v3a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2"></path>
      <path d="M12 7V2"></path>
      <line x1="2" y1="22" x2="22" y2="22"></line>
    </svg>
    <span>Lịch Sử</span>
  </button>

  <button class="topic-btn flex items-center gap-3 group" data-topic="Địa Lý">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-500 group-hover:text-white transition-colors">
      <circle cx="12" cy="12" r="10"></circle>
      <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path>
      <path d="M2 12h20"></path>
    </svg>
    <span>Địa Lý</span>
  </button>

  
</div>
    </aside>

    <div class="main">
        <div class="mobile-header lg:hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="menu-btn" class="p-2 rounded-lg text-white hover:bg-white/10 transition">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <div class="font-bold text-lg text-white">Trợ giảng AI</div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="current-topic-mobile" class="pill text-xs"> <span id="topic-name-mobile">Tổng quát</span></div>
                    <button id="theme-toggle-mobile" title="Chuyển sáng/tối" class="p-2 rounded-lg hover:bg-white/10 transition text-yellow-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                            <path d="M19 3v4"></path>
                            <path d="M21 5h-4"></path>
                        </svg>
                    </button>
                    <button id="dashboard-toggle-mobile" title="Báo cáo học tập" class="p-2 rounded-lg hover:bg-white/10 transition text-emerald-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="hidden lg:flex items-center justify-between chat-header">
            <h1 class="text-xl font-bold text-cyan-300">Cửa sổ trợ giảng</h1>
            <div class="flex items-center gap-4">
                <div id="current-topic" class="pill">Môn học đã chọn: <span id="topic-name" class="font-bold ml-1">Tổng quát</span></div>
                <button id="dashboard-toggle" title="Bảng điều khiển học tập" class="p-2 rounded-lg hover:bg-white/10 body-light:hover:bg-gray-100 transition text-emerald-400 body-light:text-emerald-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </button>
                <button id="theme-toggle" title="Chuyển sáng/tối" class="p-2 rounded-lg hover:bg-white/10 body-light:hover:bg-gray-100 transition text-yellow-300 body-light:text-orange-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                        <path d="M19 3v4"></path>
                        <path d="M21 5h-4"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="initial-greeting" class="msg">
            <div class="avatar">
               <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>
            </div>
            <div class="bubble ai markdown">
              Xin chào Thầy/Cô là <strong>Trợ giảng AI đa môn học THPT</strong>.<br>
              Thầy/Cô có thể giúp bạn học tập và giải đáp mọi thắc mắc các môn Toán, Lý, Hóa, Sinh, Tin học...<br>
              Bạn có thể chọn một môn học ở phần Menu trái (hoặc mình sẽ tự động phân loại theo câu hỏi) và bắt đầu hỏi ngay nhé!
            </div>
          </div>
        <div id="chat-window" class="chat-window flex-1">
          
        </div>

        <div class="input-wrapper">
            <div class="max-w-4xl mx-auto flex items-center gap-3 floating-input-box">
              <input id="user-input" placeholder="Nhập câu hỏi của bạn..." class="flex-1 bg-transparent text-white placeholder-gray-400 focus:outline-none px-4 py-3 text-base sm:text-lg" />
              <button id="send-btn" class="p-3 rounded-full bg-cyan-500 text-gray-900 hover:bg-cyan-400 transition shadow-lg flex items-center justify-center">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            </div>
        </div>
    </div>
    
    <div id="dashboard-container">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-cyan-800/50">
            <h2 class="text-xl font-extrabold text-white">Bảng điều khiển học tập</h2>
            <button id="close-dashboard" class="lg:hidden p-2 rounded-full hover:bg-white/10 text-white transition">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>

        <div id="dashboard-content" class="space-y-6">
            <p class="text-sm text-gray-400">
                Thông tin phân tích và đề xuất sẽ xuất hiện sau câu hỏi đầu tiên.
            </p>
            
            <div>
                <h3 class="text-lg font-bold text-cyan-400 mb-2">Mức độ Năng lực</h3>
                <div class="space-y-3 p-4 rounded-lg bg-gray-700/20 body-light:bg-gray-100">
                    <p>Môn **Mạnh nhất**: <span id="strong-area" class="font-bold text-green-400">Chưa có dữ liệu</span></p>
                    <p>Môn **Cần cải thiện**: <span id="weak-area" class="font-bold text-red-400">Chưa có dữ liệu</span></p>
                    <p id="analytics-summary" class="text-sm italic mt-3 text-gray-300">Hãy bắt đầu đặt câu hỏi để AI phân tích phong cách học của bạn!</p>
                </div>
            </div>
            
            <div>
                <h3 class="text-lg font-bold text-cyan-400 mb-2">Đề xuất Luyện tập</h3>
                <ul id="recommendations-list" class="space-y-2 list-disc list-inside text-sm">
                    <li class="text-gray-400">Đề xuất sẽ được cá nhân hóa dựa trên kết quả phân tích.</li>
                </ul>
            </div>
            
        </div>
    </div>
  </div>

  <script>
    const offcanvas = document.getElementById('offcanvas');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menu-btn');
    const closeOffcanvas = document.getElementById('close-offcanvas');
    const topicButtons = document.querySelectorAll('.topic-btn');
    const topicName = document.getElementById('topic-name');
    const topicNameMobile = document.getElementById('topic-name-mobile');
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const themeToggleMobile = document.getElementById('theme-toggle-mobile');
    const initialGreeting = document.getElementById('initial-greeting');
    const appShell = document.querySelector('.app-shell');
    const dashboardContainer = document.getElementById('dashboard-container');
    const dashboardToggle = document.getElementById('dashboard-toggle');
    const dashboardToggleMobile = document.getElementById('dashboard-toggle-mobile');
    const closeDashboard = document.getElementById('close-dashboard');

    let currentTopic = "Tổng quát";

    function toggleDashboard() {
        if (window.innerWidth >= 1024) {
            appShell.classList.toggle('dashboard-open');
            if (appShell.classList.contains('dashboard-open')) {
                dashboardContainer.style.display = 'flex';
                setTimeout(() => dashboardContainer.style.opacity = 1, 10);
            } else {
                dashboardContainer.style.opacity = 0;
                setTimeout(() => dashboardContainer.style.display = 'none', 400); 
            }
        } 
        else {
            dashboardContainer.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
            document.body.style.overflow = dashboardContainer.classList.contains('mobile-open') ? 'hidden' : ''; 
        }
    }

    if(dashboardToggle) dashboardToggle.addEventListener('click', toggleDashboard);
    if(dashboardToggleMobile) dashboardToggleMobile.addEventListener('click', toggleDashboard);
    if(closeDashboard) closeDashboard.addEventListener('click', toggleDashboard);
    overlay.addEventListener('click', () => {
        if(dashboardContainer.classList.contains('mobile-open')) {
            toggleDashboard(); 
        } else {
            closeMenu(); 
        }
    });

    menuBtn.addEventListener('click', toggleMenu);
    closeOffcanvas.addEventListener('click', closeMenu);
    
    function toggleMenu() {
        offcanvas.classList.toggle('open');
        overlay.classList.toggle('show');
        document.body.style.overflow = offcanvas.classList.contains('open') ? 'hidden' : ''; 
    }
    
    function closeMenu() {
        offcanvas.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = ''; 
    }

    function extractJsonData(responseText) {
        const jsonBlockRegex = /```json-data\s*([\s\S]*?)\s*```/;
        const match = responseText.match(jsonBlockRegex);
        
        if (match && match[1]) {
            try {
                const jsonData = JSON.parse(match[1].trim());
                return {
                    chatReply: responseText.replace(jsonBlockRegex, '').trim(), 
                    analytics: jsonData 
                };
            } catch (e) {
                console.error("Lỗi parse JSON:", e);
            }
        }
        return { chatReply: responseText, analytics: null }; 
    }
    
    function updateDashboard(jsonData) {
        document.getElementById('strong-area').textContent = jsonData.progress_strong || 'N/A';
        document.getElementById('weak-area').textContent = jsonData.progress_weak || 'N/A';
        document.getElementById('analytics-summary').textContent = jsonData.analytics_summary || 'Không có nhận xét chi tiết.';
        
        const recList = document.getElementById('recommendations-list');
        recList.innerHTML = ''; 
        
        if (jsonData.recommendations && jsonData.recommendations.length > 0) {
            jsonData.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.className = 'text-gray-200';
                li.textContent = rec;
                recList.appendChild(li);
            });
        } else {
             recList.innerHTML = '<li class="text-gray-400">Không có đề xuất mới.</li>';
        }
        
        if (window.innerWidth >= 1024 && !appShell.classList.contains('dashboard-open')) {
             appShell.classList.add('dashboard-open');
             dashboardContainer.style.display = 'flex';
             setTimeout(() => dashboardContainer.style.opacity = 1, 10);
        }
    }

    // === HÀM HIỂN THỊ LỜI CHÀO MỚI ===
    function showNewTopicGreeting(topic) {
        chatWindow.innerHTML = '';
        const msg = document.createElement('div');
        msg.className = 'msg topic-greeting';
        msg.innerHTML = `
            <div class="avatar"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg></div>
            <div class="bubble ai markdown">
              Chào em! Thầy cô là trợ giảng chuyên về môn <strong>${topic}</strong>.<br>
              Chúng ta sẽ bắt đầu bài học nào hôm nay nhỉ?
            </div>
        `;
        chatWindow.appendChild(msg);
    }

    // === XỬ LÝ SỰ KIỆN NÚT CHỌN MÔN ===
    topicButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        topicButtons.forEach(b => b.classList.remove('topic-active'));
        btn.classList.add('topic-active');
        currentTopic = btn.dataset.topic;
        topicName.textContent = currentTopic;
        topicNameMobile.textContent = currentTopic;
        
        try {
            await fetch('/new_chat', { method: 'POST' });
        } catch(e) {
            console.error("Lỗi reset chat:", e);
        }

        showNewTopicGreeting(currentTopic);
        closeMenu();
      });
    });
    
    if(initialGreeting) {
        chatWindow.appendChild(initialGreeting);
    }
    
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      document.querySelectorAll('.topic-greeting').forEach(el => el.remove());

      appendUser(message);
      userInput.value = '';
      userInput.focus();

      const typingMsg = appendTypingState();
      chatWindow.scrollTop = chatWindow.scrollHeight; 

      try {
        const res = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message }) 
        });

        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

        const data = await res.json();
        const { chatReply, analytics } = extractJsonData(data.reply);
        
        typingMsg.remove();
        await appendAIWithTyping(chatReply); 

        if (analytics) {
            updateDashboard(analytics); 
        }

      } catch (error) {
        console.error('Error sending message:', error);
        typingMsg.remove();
        appendAI('⚠️ Lỗi khi gửi yêu cầu, vui lòng thử lại.');
      }
    }

    function appendUser(text) {
      const msg = document.createElement('div');
      msg.className = 'msg user';
      msg.innerHTML = `<div class="bubble user">${text}</div><div class="avatar">Bạn</div>`;
      chatWindow.appendChild(msg);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function appendTypingState() {
        const msg = document.createElement('div');
        msg.className = 'msg loading-state';
        msg.innerHTML = `
            <div class="avatar"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg></div>
            <div class="bubble ai typing-state loading-dots">
                <span></span><span></span><span></span>
            </div>
        `;
        chatWindow.appendChild(msg);
        return msg;
    }

    function appendAI(text) {
      const msg = document.createElement('div');
      msg.className = 'msg';
      const cleanHTML = DOMPurify.sanitize(marked.parse(text));
      msg.innerHTML = `<div class="avatar">AI</div><div class="bubble ai markdown">${cleanHTML}</div>`;
      chatWindow.appendChild(msg);
      Prism.highlightAll();
      addCopyButtons(msg);
      chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });

      // === THÊM DÒNG NÀY: VẼ LẠI CÔNG THỨC ===
      if (window.MathJax) {
          MathJax.typesetPromise([msg]).catch((err) => console.log(err));
      }
    }
    
    async function appendAIWithTyping(fullText) {
        const msg = document.createElement('div');
        msg.className = 'msg';
        msg.innerHTML = `
            <div class="avatar"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg></div>
            <div class="bubble ai markdown typing-simulation">
                <span class="typing-target"></span><span class="cursor">|</span>
            </div>
        `;
        chatWindow.appendChild(msg);
        
        const targetSpan = msg.querySelector('.typing-target');
        const markdownContainer = msg.querySelector('.markdown');
        
        let currentText = '';
        const typingSpeed = 5; 
        const totalCharacters = fullText.length;

        for (let i = 0; i < totalCharacters; i++) {
            currentText += fullText.charAt(i);
            targetSpan.textContent = currentText; 
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            if (['\n', '.', '!', '?', ','].includes(fullText.charAt(i))) {
                await new Promise(resolve => setTimeout(resolve, 80));
            } else if (fullText.charAt(i) === ' ' && fullText.charAt(i+1) === ' ') {
                await new Promise(resolve => setTimeout(resolve, 50));
            } 
            else {
                await new Promise(resolve => setTimeout(resolve, typingSpeed));
            }
        }

        const cleanHTML = DOMPurify.sanitize(marked.parse(fullText));
        markdownContainer.innerHTML = cleanHTML; 
        Prism.highlightAll();
        addCopyButtons(msg);
        chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });

        // === THÊM DÒNG NÀY: VẼ LẠI CÔNG THỨC ===
        if (window.MathJax) {
            MathJax.typesetPromise([msg]).catch((err) => console.log(err));
        }
    }

    function addCopyButtons(msgElement) {
        const codeBlocks = msgElement.querySelectorAll('pre');
        codeBlocks.forEach(pre => {
            const button = document.createElement('button');
            button.className = 'copy-btn';
            button.innerHTML = `
                <svg class="copy-icon" viewBox="0 0 24 24">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <span>Copy</span>
            `;
            button.addEventListener('click', async () => {
                const code = pre.querySelector('code').innerText;
                const buttonText = button.querySelector('span');
                const buttonIcon = button.querySelector('.copy-icon');
                try {
                    await navigator.clipboard.writeText(code);
                    buttonText.textContent = 'Đã sao chép!';
                    buttonIcon.classList.add('copy-icon-copied');
                    setTimeout(() => {
                        buttonText.textContent = 'Copy';
                        buttonIcon.classList.remove('copy-icon-copied');
                    }, 2000);
                } catch (err) {
                    console.error('Không thể sao chép: ', err);
                }
            });
            pre.appendChild(button);
        });
    }

    function toggleTheme() {
        document.body.classList.toggle('light');
        localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
    }

    themeToggle.addEventListener('click', toggleTheme);
    themeToggleMobile.addEventListener('click', toggleTheme);

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light' || (!savedTheme && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            document.body.classList.add('light');
        }
    }
    loadTheme();
  </script>
</body>
</html>

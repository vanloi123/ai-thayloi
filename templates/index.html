<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ü§ñ AI Th·∫ßy L·ª£i - Tr·ª£ l√Ω Tin h·ªçc</title>

  <!-- Tailwind + Markdown + Code highlight -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.css">
  <script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"></script>

  <style>
    :root {
      --main: #00ffff;
      --dark-bg: #01131a;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark-bg);
      color: white;
      display: flex;
      min-height: 100vh;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }

    /* Hi·ªáu ·ª©ng n·ªÅn */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, #00ffff22, transparent 60%),
                  radial-gradient(circle at 80% 80%, #0077ff33, transparent 60%);
      animation: gradientMove 15s infinite alternate;
      z-index: -1;
    }
    @keyframes gradientMove {
      0% { background-position: 0 0, 100% 100%; }
      100% { background-position: 100% 0, 0 100%; }
    }

    /* Hi·ªáu ·ª©ng g√µ */
    .typing-indicator span {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: var(--main);
      border-radius: 50%;
      animation: blink 1.3s infinite both;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
      40% { opacity: 1; transform: scale(1.3); }
    }

    /* Copy button */
    .copy-btn {
      position: absolute;
      top: 5px;
      right: 8px;
      background: var(--main);
      color: #01131a;
      border: none;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8em;
      cursor: pointer;
      transition: 0.2s;
    }
    .copy-btn:hover { background: #00baba; }

    /* Markdown */
    .markdown h3 { color: var(--main); font-weight: 600; margin-top: 10px; }
    .markdown p, .markdown li { margin-bottom: 8px; line-height: 1.6; }
    .markdown pre {
      background: #0a1f2e;
      padding: 12px;
      border-radius: 10px;
      overflow-x: auto;
      position: relative;
      color: var(--main);
    }

    /* ·∫®n thanh l·ªãch s·ª≠ tr√™n mobile */
    @media (max-width: 768px) {
      #history-panel { display: none; }
    }
  </style>
</head>

<body>
  <!-- Panel L·ªãch s·ª≠ h·ªôi tho·∫°i -->
  <aside id="history-panel" class="w-64 bg-white/10 backdrop-blur-lg border-r border-cyan-500/30 p-4 flex flex-col">
    <h2 class="text-lg font-bold text-cyan-400 mb-3">üïì L·ªãch s·ª≠ h·ªôi tho·∫°i</h2>
    <div id="history" class="flex-1 overflow-y-auto space-y-2">
      <p class="text-gray-400 text-sm">Ch∆∞a c√≥ h·ªôi tho·∫°i n√†o...</p>
    </div>
    <button onclick="clearHistory()" class="mt-3 bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-semibold py-2 rounded-lg">
      üóë X√≥a l·ªãch s·ª≠
    </button>
  </aside>

  <!-- Khu v·ª±c ch√≠nh -->
  <div class="flex-1 flex flex-col items-center justify-between">
    <!-- Header -->
    <header class="w-full flex justify-between items-center p-4 max-w-5xl">
      <div class="flex items-center gap-3">
        <img src="{{ url_for('static', filename='logo.png') }}" class="w-14 h-14 rounded-full shadow-lg">
        <div>
          <h1 class="text-xl font-bold text-cyan-400">AI Th·∫ßy L·ª£i</h1>
          <p class="text-sm opacity-80">Tr·ª£ l√Ω h·ªçc Tin h·ªçc - C·∫•p THPT</p>
        </div>
      </div>
      <button id="mode-btn" class="bg-cyan-400 text-gray-900 px-4 py-2 rounded-full font-semibold hover:bg-cyan-300">
        üåô T·ªëi
      </button>
    </header>

    <!-- Chat Box -->
    <main id="chat-box" class="w-full max-w-3xl flex-1 overflow-y-auto p-4 bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg space-y-4">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-500 font-bold">AI</div>
        <div class="bg-[#083344] text-white px-4 py-3 rounded-2xl rounded-bl-none markdown">
          Xin ch√†o üëã M√¨nh l√† <b>AI Th·∫ßy L·ª£i</b> c·ªßa <b>Tr∆∞·ªùng PTDTNT THPT M∆∞·ªùng Nh√©</b>.<br>
          H√£y h·ªèi m√¨nh b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n <b>Tin h·ªçc</b> nh√©!
        </div>
      </div>
    </main>

    <!-- Input -->
    <div class="w-full max-w-3xl flex items-center mt-4 mb-6 bg-white/10 backdrop-blur-lg rounded-full px-4 py-2 shadow-lg">
      <input id="user-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..."
             class="flex-1 bg-transparent text-white focus:outline-none px-3 py-2"
             onkeypress="if(event.key==='Enter'){sendMessage();}">
      <button onclick="sendMessage()" class="p-2 rounded-full bg-cyan-400 text-gray-900 hover:bg-cyan-300">
        üì§
      </button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("user-input");
    const historyDiv = document.getElementById("history");
    let history = JSON.parse(localStorage.getItem("aiHistory") || "[]");

    // Hi·ªÉn th·ªã l·∫°i l·ªãch s·ª≠
    updateHistory();

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      input.value = "";

      addHistory(message);

      chatBox.innerHTML += `
        <div class="flex items-start justify-end gap-3">
          <div class="bg-cyan-400 text-gray-900 px-4 py-3 rounded-2xl rounded-br-none max-w-[80%]">${message}</div>
          <div class="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-500 font-bold">üë©‚Äçüíª</div>
        </div>`;
      chatBox.scrollTop = chatBox.scrollHeight;

      const typing = document.createElement("div");
      typing.className = "flex items-start gap-3";
      typing.innerHTML = `
        <div class="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-500 font-bold">AI</div>
        <div class="bg-[#083344] px-4 py-3 rounded-2xl rounded-bl-none">
          <div class="typing-indicator"><span></span><span></span><span></span></div>
        </div>`;
      chatBox.appendChild(typing);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        typing.remove();

        const aiBubble = document.createElement("div");
        aiBubble.className = "flex items-start gap-3";
        aiBubble.innerHTML = `
          <div class="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-500 font-bold">AI</div>
          <div class="bg-[#083344] text-white px-4 py-3 rounded-2xl rounded-bl-none markdown"></div>`;
        chatBox.appendChild(aiBubble);
        chatBox.scrollTop = chatBox.scrollHeight;

        const bubble = aiBubble.querySelector(".markdown");
        const html = marked.parse(data.reply);
        let i = 0;
        function typeEffect() {
          bubble.innerHTML = html.slice(0, i++);
          Prism.highlightAll();
          chatBox.scrollTop = chatBox.scrollHeight;
          if (i <= html.length) setTimeout(typeEffect, 10);
          else {
            addCopyButtons();
            speakWithGoogleTTS(data.reply);
          }
        }
        typeEffect();
      } catch (err) {
        typing.remove();
        chatBox.innerHTML += `
          <div class="flex items-start gap-3 text-red-400">
            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-cyan-500 font-bold">AI</div>
            <div class="px-4 py-3 bg-[#400] rounded-2xl">‚ùå L·ªói: ${err}</div>
          </div>`;
      }
    }

    function addHistory(message) {
      history.unshift({ message, time: new Date().toLocaleTimeString() });
      if (history.length > 10) history.pop();
      localStorage.setItem("aiHistory", JSON.stringify(history));
      updateHistory();
    }

    function updateHistory() {
      historyDiv.innerHTML = history.length
        ? history.map(h => `<div class="bg-cyan-900/30 p-2 rounded-lg cursor-pointer hover:bg-cyan-800/40" onclick="loadMessage('${h.message}')">üí¨ ${h.message}</div>`).join("")
        : `<p class="text-gray-400 text-sm">Ch∆∞a c√≥ h·ªôi tho·∫°i n√†o...</p>`;
    }

    function loadMessage(msg) {
      input.value = msg;
      input.focus();
    }

    function clearHistory() {
      history = [];
      localStorage.removeItem("aiHistory");
      updateHistory();
    }

    function speakWithGoogleTTS(text) {
      const encoded = encodeURIComponent(text);
      const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&tl=vi&client=tw-ob&q=${encoded}`);
      audio.play().catch(err => console.warn("Kh√¥ng th·ªÉ ph√°t √¢m thanh:", err));
    }

    function addCopyButtons() {
      document.querySelectorAll("pre").forEach(pre => {
        if (pre.querySelector(".copy-btn")) return;
        const btn = document.createElement("button");
        btn.className = "copy-btn";
        btn.textContent = "Copy";
        btn.onclick = () => {
          navigator.clipboard.writeText(pre.innerText);
          btn.textContent = "‚úì Copied!";
          setTimeout(() => btn.textContent = "Copy", 1500);
        };
        pre.appendChild(btn);
      });
    }

    document.getElementById("mode-btn").onclick = function() {
      document.body.classList.toggle("bg-white");
      document.body.classList.toggle("text-gray-900");
      this.textContent = document.body.classList.contains("bg-white") ? "üåû S√°ng" : "üåô T·ªëi";
    };
  </script>
</body>
</html>

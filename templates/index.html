<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AI Th·∫ßy L·ª£i - Tr·ª£ l√Ω h·ªçc Tin h·ªçc | C·∫•p Ba M∆∞·ªùng Nh√©</title>

<!-- Markdown + Code Highlight -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs/components/prism-python.min.js"></script>

<style>
:root {
  --cyan: #00ffff;
  --cyan-light: #8efcff;
  --dark-bg: #001e28;
  --light-bg: #f3f8fa;
  --text-dark: #001e28;
  --text-light: #f9ffff;
  --ai-bubble: #063444;
  --user-bubble: #00ffff;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: var(--dark-bg);
  color: var(--text-light);
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
  min-height: 100dvh;
  transition: 0.3s ease-in-out;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 95%;
  max-width: 900px;
  padding: 15px 0;
}

#logo {
  height: 60px;
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(0,255,255,0.6);
}

#mode-btn {
  background: none;
  border: 2px solid var(--cyan);
  border-radius: 50px;
  color: var(--cyan);
  font-weight: bold;
  cursor: pointer;
  padding: 6px 14px;
  transition: 0.3s;
}
#mode-btn:hover { background: var(--cyan); color: var(--dark-bg); }

h1 {
  color: var(--cyan);
  text-align: center;
  font-size: clamp(1.3em, 3vw, 1.8em);
  margin: 0;
  text-shadow: 0 0 10px rgba(0,255,255,0.3);
}

#chat-box {
  width: 95%;
  max-width: 900px;
  flex: 1;
  margin-top: 15px;
  padding: 20px;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.05);
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
  overflow-y: auto;
  scroll-behavior: smooth;
}

/* Tin nh·∫Øn */
.message { display: flex; margin-bottom: 12px; }
.user { justify-content: flex-end; }
.ai { justify-content: flex-start; }

.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--cyan);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--dark-bg);
  font-weight: bold;
  margin: 0 10px;
  box-shadow: 0 0 8px rgba(0,255,255,0.5);
}

.bubble {
  max-width: 75%;
  padding: 12px 16px;
  border-radius: 18px;
  line-height: 1.6;
  animation: fadeIn 0.3s ease;
}

.user .bubble {
  background: var(--user-bubble);
  color: var(--dark-bg);
  border-bottom-right-radius: 0;
  box-shadow: 0 0 12px rgba(0,255,255,0.3);
}

.ai .bubble {
  background: var(--ai-bubble);
  color: var(--text-light);
  border-bottom-left-radius: 0;
  box-shadow: 0 0 15px rgba(0,255,255,0.15);
}

/* G√µ 3 ch·∫•m */
.typing-indicator span {
  display: inline-block;
  width: 8px; height: 8px;
  margin: 0 2px;
  background: var(--cyan);
  border-radius: 50%;
  opacity: 0.5;
  animation: blink 1.4s infinite both;
}
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.3; transform: scale(1); }
  40% { opacity: 1; transform: scale(1.3); }
}

#input-area {
  display: flex;
  width: 95%;
  max-width: 900px;
  margin: 15px auto 25px;
  border-radius: 50px;
  background: rgba(255,255,255,0.08);
  box-shadow: 0 0 10px rgba(0,255,255,0.25);
  overflow: hidden;
}

input {
  flex: 1;
  padding: 14px 20px;
  border: none;
  outline: none;
  background: transparent;
  color: var(--text-light);
  font-size: 1em;
}

button#send-btn {
  background: var(--cyan);
  color: var(--dark-bg);
  border: none;
  width: 70px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
}
button#send-btn:hover { background: var(--cyan-light); }

/* Markdown */
.markdown pre {
  background: #011a22;
  border-radius: 12px;
  padding: 10px;
  overflow-x: auto;
  position: relative;
  margin: 10px 0;
}
.copy-btn {
  position: absolute; top: 8px; right: 10px;
  background: var(--cyan);
  border: none;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 0.8em;
  cursor: pointer;
}

/* Light Mode */
body.light { background: var(--light-bg); color: var(--text-dark); }
body.light #chat-box { background: #ffffff; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
body.light .ai .bubble { background: #e0f7fa; color: var(--text-dark); }
body.light .user .bubble { background: #00bcd4; color: #ffffff; }
body.light input { color: var(--text-dark); }
body.light #input-area { background: #ffffff; border: 1px solid #00bcd4; }
body.light button#send-btn { background: #00bcd4; color: #fff; }

/* Animation */
@keyframes fadeIn { from {opacity:0;transform:translateY(10px);} to {opacity:1;transform:translateY(0);} }

/* Responsive */
@media (max-width:768px){
  #chat-box{height:65vh;}
  .bubble{max-width:85%;}
}
@media (max-width:480px){
  #logo{height:45px;}
  h1{font-size:1em;}
  #input-area{margin-bottom:15px;}
}
</style>
</head>

<body>
<header>
  <img id="logo" src="{{ url_for('static', filename='logo.png') }}" alt="Logo Tr∆∞·ªùng C·∫•p Ba M∆∞·ªùng Nh√©">
  <button id="mode-btn" onclick="toggleMode()">üåô Dark</button>
</header>

<h1>ü§ñ AI Th·∫ßy L·ª£i - Tr·ª£ l√Ω h·ªçc Tin h·ªçc<br>
<i style="font-size:0.8em;color:#00ffffcc;">‚ÄúH·ªçc c√πng AI - Ch·∫°m t∆∞∆°ng lai‚Äù</i>
</h1>

<div id="chat-box">
  <div class="message ai">
    <div class="avatar">AI</div>
    <div class="bubble markdown">
      Xin ch√†o üëã M√¨nh l√† <b>AI Th·∫ßy L·ª£i</b> c·ªßa <b>Tr∆∞·ªùng PTDTNT THPT M∆∞·ªùng Nh√©</b>.<br>
      H√£y h·ªèi m√¨nh b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ m√¥n <b>Tin h·ªçc</b> nh√©!
    </div>
  </div>
</div>

<div id="input-area">
  <input id="user-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." onkeypress="if(event.key==='Enter'){sendMessage();}">
  <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
</div>

<script>
async function sendMessage() {
  const input = document.getElementById("user-input");
  const chatBox = document.getElementById("chat-box");
  const message = input.value.trim();
  if (message === "") return;

  chatBox.innerHTML += `
    <div class="message user">
      <div class="bubble">${message}</div>
      <div class="avatar">üë©‚Äçüíª</div>
    </div>`;
  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  const typing = document.createElement("div");
  typing.className = "message ai";
  typing.innerHTML = `
    <div class="avatar">AI</div>
    <div class="bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
  chatBox.appendChild(typing);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message })
    });
    const data = await res.json();
    typing.remove();

    const aiMessage = document.createElement("div");
    aiMessage.className = "message ai";
    aiMessage.innerHTML = `<div class="avatar">AI</div><div class="bubble markdown"></div>`;
    chatBox.appendChild(aiMessage);
    chatBox.scrollTop = chatBox.scrollHeight;

    const bubble = aiMessage.querySelector(".bubble");
    const text = marked.parse(data.reply);
    let i = 0;
    function typeEffect() {
      bubble.innerHTML = text.slice(0, i++);
      Prism.highlightAll();
      chatBox.scrollTop = chatBox.scrollHeight;
      if (i <= text.length) {
        setTimeout(typeEffect, 8);
      } else {
        addCopyButtons();
        speakWithGoogleTTS(data.reply);
      }
    }
    typeEffect();
  } catch (err) {
    typing.remove();
    chatBox.innerHTML += `
      <div class="message ai">
        <div class="avatar">AI</div>
        <div class="bubble" style="color:red;">‚ùå L·ªói: ${err}</div>
      </div>`;
  }
}

function speakWithGoogleTTS(text) {
  const sentences = text.split(/(?<=[.!?])\s+/);
  let i = 0;
  function playNext() {
    if (i >= sentences.length) return;
    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&tl=vi&client=tw-ob&q=${encodeURIComponent(sentences[i++])}`);
    audio.onended = playNext;
    audio.play().catch(err => console.warn("Kh√¥ng th·ªÉ ph√°t √¢m thanh:", err));
  }
  playNext();
}

function addCopyButtons() {
  document.querySelectorAll("pre").forEach(pre => {
    if (pre.querySelector(".copy-btn")) return;
    const btn = document.createElement("button");
    btn.className = "copy-btn";
    btn.textContent = "Copy";
    btn.onclick = () => {
      navigator.clipboard.writeText(pre.innerText);
      btn.textContent = "‚úì Copied!";
      setTimeout(() => btn.textContent = "Copy", 1500);
    };
    pre.appendChild(btn);
  });
}

function toggleMode() {
  const body = document.body;
  const btn = document.getElementById("mode-btn");
  body.classList.toggle("light");
  btn.textContent = body.classList.contains("light") ? "üåû Light" : "üåô Dark";
}
</script>
</body>
</html>
